# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Repository Overview

tree-sitter-r is an R grammar implementation for [tree-sitter](https://github.com/tree-sitter/tree-sitter), a parser generator tool and incremental parsing library. This repository provides:

1. The core grammar implementation for the R language
2. Node.js bindings for use in JavaScript/TypeScript projects
3. Rust bindings for use in Rust projects
4. R package bindings for use in R projects

The grammar precisely implements R language syntax with a few documented deviations, focusing on providing a useful syntax tree structure for tooling.

## Common Development Commands

### Core Grammar Development

```bash
# Install dependencies
npm install

# Build the grammar and generate parser
tree-sitter generate

# Start the tree-sitter playground for testing
npm run start

# Run parser tests
tree-sitter test

# Generate WASM build
tree-sitter build --wasm
```

### Node.js Package

```bash
# Install dependencies
npm install

# Run Node bindings tests
node --test bindings/node/*_test.js

# Build Node bindings
node-gyp rebuild
```

### Rust Crate

```bash
# Build Rust crate
cargo build

# Test Rust crate
cargo test
```

### R Package

```bash
# Build and check R package
cd bindings/r
R CMD build .
R CMD check treesitter.r_*.tar.gz

# Run R package tests
cd bindings/r
R -e 'devtools::test()'
```

## Repository Structure

- `/grammar.js` - The main grammar definition file defining R syntax rules
- `/src/` - Contains parser implementation files generated by tree-sitter
  - `parser.c` - The core parser implementation
  - `scanner.c` - Custom scanner for handling context-sensitive tokens
- `/bindings/` - Language-specific bindings
  - `/bindings/node/` - Node.js bindings
  - `/bindings/rust/` - Rust bindings
  - `/bindings/r/` - R package implementation
- `/test/` - Test files for the grammar
  - `/test/corpus/` - Syntax test cases
  - `/test/highlight/` - Syntax highlighting test cases
  - `/test/tags/` - Symbol tagging test cases

## Architecture

The tree-sitter-r project follows the standard tree-sitter architecture:

1. **Grammar Definition**: The core of the project is the `grammar.js` file that defines the grammar rules for parsing R code. It defines all language constructs like expressions, statements, operators, etc.

2. **Generated Parser**: The tree-sitter CLI uses the grammar definition to generate the actual parser implementation in C, which is stored in `src/parser.c`.

3. **Custom Scanner**: For handling context-sensitive aspects of the R syntax, a custom scanner is implemented in `src/scanner.c`. This handles special cases that cannot be expressed using the grammar alone.

4. **Language Bindings**: The project provides bindings for Node.js, Rust, and R, allowing the parser to be used from these languages.

5. **Tests**: Comprehensive tests in the `/test` directory verify the grammar works as expected with different R constructs.

## Working with the Grammar

When modifying the grammar:

1. Edit `grammar.js` to make your changes to the grammar definition
2. Run `tree-sitter generate` to regenerate the parser
3. Test your changes with `tree-sitter test`
4. Use `npm run start` to launch the playground for interactive testing

## Known Grammar Deviations

As noted in the README, there are a few intentional deviations from the R grammar, particularly around how `]]` tokens are handled. See the README.md for details.
